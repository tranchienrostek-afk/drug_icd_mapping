# AI EXECUTION REPORT (BÁO CÁO THỰC THI)

**Task ID:** Task 010 (Fix BUG-009 Critical Scraper Failures)
**Thời gian:** 2026-01-07 15:20
**Trạng thái:** ✅ Success

## 1. Tóm tắt Giải pháp (Summary)
Khắc phục 3 nhóm lỗi nghiêm trọng của Web Scraper:
1. **DNS Failure (TrungTamThuoc)**: Tạm disable site này trong config.
2. **Selector Timeouts**: Thay XPath ID cứng bằng CSS fallback selectors.
3. **Silent Failures**: Cải thiện error logging và propagation.

## 2. Chi tiết Thay đổi (File Changes)

### [REFACTOR] `app/service/crawler/config.py` (v3)
- **TrungTamThuoc**: `enabled: False` (DNS issue is infra, not code).
- **ThuocBietDuoc**: Replaced `//*[@id='ctl00_...']` with:
  - `input[name*='TenThuoc']` (CSS attribute)
  - `input[id*='txtTenThuoc']` (CSS ID contains)
- **DAV**: Replaced `//input[@id='txtTenThuoc']` with:
  - `#txtTenThuoc` (CSS ID)
  - `input[placeholder*='tên thuốc']` (CSS attribute)
  - `input[type='text']` (Last resort fallback)

### [REFACTOR] `app/service/crawler/core_drug.py`
- Added `try_selectors()` helper: Iterates through selector list, returns first match.
- Improved error handling: `NETWORK ERROR` vs `SELECTOR ERROR` vs `GLOBAL ERROR`.
- In-page extraction for table-based sites (DAV).

## 3. Nhật ký Lệnh (Command Log)
```bash
$ python scripts/2026_01_07_debug_crawler_manual.py
> [DAV] Found input using: input[type='text']
> [DAV] FINISHED in 44.45s
> [WebAdvanced] Total items found: ...
> Exit code: 0
```

## 4. Kết luận
Scraper giờ đây sử dụng chiến lược fallback selector thay vì XPath ID cứng (dễ gãy).
Site TrungTamThuoc bị disable tạm thời do lỗi DNS cần fix ở tầng Infra.

## 5. Bài học đúc kết thành tri thức cho hệ thống (Lessons Learned)
- **ASP.NET WebForms**: ID thường có prefix động (`ctl00_ContentPlaceHolder1_...`). Dùng CSS `[name*='...']` hoặc `[id*='...']` thay thế.
- **Selector Strategy**: Luôn cung cấp list fallback selectors theo thứ tự: CSS ID > CSS Attribute > XPath.
- **Network vs Code**: Lỗi DNS (`ERR_NAME_NOT_RESOLVED`) không thể fix bằng code, cần disable site hoặc fix infra.
