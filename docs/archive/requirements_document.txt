# TÀI LIỆU YÊU CẦU KỸ THUẬT: HỆ THỐNG QUẢN LÝ DỮ LIỆU & NHẬN DIỆN THUỐC (AZINSU)

**Ngày cập nhật:** 07/01/2026
**Trạng thái:** Triển khai (Deployment Phase)
**Người lập:** Trần Văn Chiến

---

## I. TỔNG QUAN

Tài liệu quy định quy trình xử lý vòng đời dữ liệu thuốc, thuật toán nhận diện thuốc đa tầng (Database & Web Search), và cơ chế xây dựng Knowledge Graph liên kết Thuốc - Bệnh lý. Mục tiêu là đảm bảo tính toàn vẹn dữ liệu, khả năng truy vết (traceability) và độ chính xác cao trong suy luận AI.

---

## II. QUY TRÌNH QUẢN LÝ THAY ĐỔI DỮ LIỆU (DATA CHANGE MANAGEMENT)

### 1. Nguyên tắc cốt lõi

* **Không xóa dữ liệu (No Delete Policy):** Mọi dữ liệu bị ghi đè, từ chối hoặc bản nháp đều được lưu trữ vào bảng lưu trữ lịch sử (Warehouse/Archive) để phục vụ truy vết và backup.
* **Traceability:** Mọi thao tác thêm mới/sửa đổi phải log lại: `Thời gian thực hiện`, `Người thực hiện`.

### 2. Logic Thêm/Cập nhật Thuốc vào Database

Hệ thống kiểm tra Số đăng ký (SĐK) và Tên thuốc khi có yêu cầu thêm dữ liệu:

* **Trường hợp 1: Dữ liệu hoàn toàn mới** (Cả SĐK và Tên thuốc chưa từng xuất hiện).
* **Hành động:** Thêm trực tiếp vào Database chính.
* **Yêu cầu:** Ghi log hệ thống.


* **Trường hợp 2: Phát hiện trùng lặp** (SĐK hoặc Tên thuốc đã tồn tại).
* **Hành động:**
1. Hệ thống hiển thị so sánh 2 bản ghi: [Dữ liệu cũ trong DB] vs [Dữ liệu mới].
2. Chuyển dữ liệu mới vào trạng thái **Staging (Chờ xác nhận)**.
3. Cần API xác nhận (Manual Confirm) để quyết định: Ghi đè hay Không ghi đè.


* **Tính năng Staging:**
* Cho phép: Thêm/Sửa/Xóa bản nháp tại Staging.
* Nếu chọn **Ghi đè**: Dữ liệu cũ được đẩy vào "Warehouse", dữ liệu mới (kèm tên người sửa) được cập nhật vào DB chính.
* Nếu **Chưa xác nhận**: Dữ liệu cũ giữ nguyên, dữ liệu mới nằm ở Staging.





### 3. Cấu trúc dữ liệu mở rộng (Bảng Thuốc)

Bổ sung các trường thông tin sau:

* **Phân loại (Classification):**
* `Thuốc`
* `Vitamin/Thuốc bổ`
* `Thực phẩm chức năng`
* `Thiết bị/Vật tư y tế`


* **Ghi chú (Appraiser Note):** Note quan trọng của thẩm định viên (Input quan trọng cho AI suy luận sau này).

---

## III. THUẬT TOÁN NHẬN DIỆN THUỐC (DRUG IDENTIFICATION ALGORITHM)

**Endpoint:** `/api/v1/drugs/identify`
**Phương pháp:** Tìm kiếm phân tầng (Tiered Search Approach).

### Tầng 1: Tìm kiếm trong Database (Ưu tiên cao nhất)

Sử dụng `search_drug_smart` với logic sau:

1. **Khớp chính xác (Exact Match):** Tên đúng + Đã có SĐK + Trạng thái Verified.
* **Độ tin cậy:** 100%.
* **Nguồn:** Database.


2. **Khớp Vector/Fuzzy (Smart Match):**
* Sử dụng Fuzzy Map & Embedding (TF-IDF/Vector Scikit-learn).
* Nếu Similarity Score > 0.9 + Đã có SĐK + Trạng thái Verified.
* **Độ tin cậy:** 90%.
* **Nguồn:** Database (kèm link tham khảo nếu có).



*Lưu ý:* Nếu tìm thấy tên nhưng chưa có SĐK hoặc chưa Verified -> Chuyển sang Tầng 2 (Search Web).

### Tầng 2: Tìm kiếm Web (Web Crawler & Scraping)

Sử dụng khi không tìm thấy trong DB hoặc dữ liệu DB chưa đủ điều kiện.

1. **Cơ chế Search:**
* Tìm trên các trang nguồn đã cấu hình.
* Mỗi trang lấy tối đa 2 thuốc có SĐK.
* **Điều kiện dừng:** Tìm được 3-4 thuốc có SĐK **HOẶC** đã duyệt qua 3 website.


2. **Cơ chế Gộp dữ liệu (Merge Strategy):**
* Chọn 2 thuốc có SĐK trùng nhau từ các nguồn khác nhau.
* **Tên thuốc:** Ưu tiên tên từ Link đầu tiên.
* **Chỉ định/Công dụng:** Gộp nội dung từ các link (Merge unique info).
* **Nguồn:** Lưu tất cả các link làm gợi ý.
* **Độ tin cậy:** 80%.



### Tầng 3: Xử lý dữ liệu thô & Làm sạch

* **Phân tích HTML:** Sử dụng `BeautifulSoup`.
* **Thông tin cần lấy:** Tên thuốc, Hoạt chất, SĐK, Chỉ định/Công dụng.
* **Quy tắc:**
* Clean text: Xóa khoảng trắng thừa, dấu chấm phẩy, chuẩn hóa tên công ty.
* Chống trùng lặp: Check với `df_initial` (dữ liệu cũ), nếu trùng tên/SĐK thì bỏ qua (continue).



---

## IV. ĐẶC TẢ KỸ THUẬT WEB CRAWLER (Xpath & Selector)

Để khắc phục tình trạng Scraper hoạt động kém trên các site thuốc biệt dược, áp dụng bảng Selector chuẩn sau:

| Đối tượng | Loại Selector | Giá trị (Code) | Ghi chú |
| --- | --- | --- | --- |
| **Link chi tiết** | XPath | `/html/body/main/section[3]/div/div/div/div[2]/div/div/a` | Link từ trang search |
| **Tên thuốc** | CSS Selector | `h1` | Độ tin cậy cao |
| **Số đăng ký** | Relative XPath | `//div[contains(text(), 'Số đăng ký')]/following-sibling::div` |  |
| **Hoạt chất** | CSS Class | `.ingredient-content` |  |
| **Chỉ định** | CSS ID (Ưu tiên) | `#chi-dinh` |  |
| **Chỉ định** | XPath (Dự phòng) | `//h2[contains(text(), 'Chỉ định')]/following-sibling::div` |  |

*Logic điều hướng:* Nếu Search ra 1 kết quả -> Click ngay. Nếu ra 2 kết quả -> Click lần lượt từng kết quả để lấy chi tiết.

---

## V. QUY TRÌNH LIÊN KẾT THUỐC & BỆNH LÝ (KNOWLEDGE GRAPH LINKING)

**Endpoint:** `/api/v1/drugs/knowledge/link`

### 1. Mô hình dữ liệu liên kết

JSON Input:

```json
{
  "disease_name": "Đau đầu",
  "drug_name": "Panadol Extra",
  "icd_code": "R51",
  "sdk": "VN-12345-67",
  "relationship_type": "Thuốc điều trị", 
  "creator": "System/User_Name"
}

```

**Trường `relationship_type` (Phân loại mối quan hệ):**

1. Thuốc điều trị
2. Thuốc hỗ trợ
3. Thuốc không điều trị
4. Từ chối chi trả
5. Không xác định

### 2. Logic Xử lý Liên kết (Staging Link)

* **Phụ thuộc dữ liệu:** Mối liên kết chỉ được tạo chính thức (Active) khi cả `Thuốc` (theo SĐK) và `Bệnh` (theo ICD) đã tồn tại và được duyệt trong Database.
* **Cơ chế Staging:**
* Nếu Thuốc hoặc Bệnh chưa có/chưa duyệt -> Mối liên kết được lưu vào **Staging Link**.
* Hệ thống sẽ tự động gọi API tạo mới Thuốc/Bệnh (theo quy trình ở Mục II).
* Khi Thuốc/Bệnh được duyệt -> Kích hoạt mối liên kết.


* **Xử lý Conflict:** Tương tự như dữ liệu thuốc. Có các hành động: Phê duyệt, Từ chối, Điều chỉnh.
* Nếu Từ chối -> Chuyển về Warehouse.
* Có API hỗ trợ `Clear Data Staging` (Chuyển toàn bộ Staging về Warehouse để xử lý sau).



### 3. Logic Phân tích (Treatment Analysis)

**Endpoint:** `/api/v1/analysis/treatment-analysis`

* **Input:** Danh sách Thuốc (3) x Danh sách Bệnh (2).
* **Quy trình:**
1. Quét ma trận (3x2) dựa trên cặp (SĐK - ICD) trong Database.
2. **Độ tin cậy 100%:** Nếu mối liên kết đã tồn tại và trạng thái là "Đã phê duyệt" + Loại là "Thuốc điều trị/Hỗ trợ".
3. **Độ tin cậy 90%:** Nếu mối liên kết tồn tại nhưng chưa phê duyệt.
4. **Loại trừ:** Nếu quan hệ là "Từ chối chi trả" hoặc "Không điều trị".
5. **Dùng AI:** Với các cặp chưa có trong DB, AI sẽ suy luận dựa trên trường `Note` (của thẩm định viên) và `Chỉ định`.



---

## VI. KẾ HOẠCH TRIỂN KHAI (DEPLOYMENT PLAN)

**Timeline:** Ngày 07/01/2026

1. **Deploy Server:** Đẩy toàn bộ code mới (API Identify, Crawler, Link Logic) lên môi trường Production.
2. **Verify & Logs:**
* Chạy script test (`scripts/verify_identify.py`).
* Khai thác logs hệ thống để theo dõi các case thêm mới/ghi đè.


3. **Database Migration:** Cập nhật schema bảng Thuốc (thêm cột Classification, Note) và bảng Liên kết.

---

*Yêu cầu toàn bộ team Dev đọc kỹ và tuân thủ logic xử lý dữ liệu để tránh mất mát thông tin trong quá trình Staging/Override.*

---

## VII. ĐÁNH GIÁ & GHI CHÚ (REVIEW NOTES - 07/01/2026)

Sau khi rà soát implementation thực tế so với PRD, tôi có một số nhận xét sau:

1.  **Dữ liệu (Section II & III):**
    *   **Đã đạt:** Các trường `classification` và `note` đã được thêm vào schema DB. Cơ chế Staging và History hoạt động đúng theo yêu cầu "No Delete".
    *   **Lưu ý:** Cần đảm bảo tham số `modified_by` luôn được truyền từ Frontend để ghi nhận đúng người thực hiện thay đổi.

2.  **Thuật toán Nhận diện (Section III & IV):**
    *   **Khác biệt logic Selector:** Các Selector trong code (`web_crawler.py`) hiện đang khác so với Section IV của PRD (đã được update để robust hơn với cấu trúc web mới). 
    *   **Đề xuất:** Cập nhật lại Section IV của PRD theo bộ chọn (Selectors) thực tế đang chạy ổn định để team Dev/QC sau này dễ theo dõi.
    *   **Tối ưu hóa:** Hiện tại hệ thống đang quét toàn bộ 3 website rồi mới gộp. Có thể tối ưu "Stop Early" (dừng ngay khi tìm đủ 3-4 thuốc có SĐK) để tăng tốc độ phản hồi API.

3.  **Liên kết & Phân tích (Section V):**
    *   **Đã đạt:** Logic phân tầng (Verified -> Pending -> AI) đã được triển khai trong Prompt LLM thông qua các prefix `[VERIFIED]` và `[PENDING APPROVAL]`.
    *   **Lưu ý:** Đã xử lý lỗi trích xuất dữ liệu bệnh lý (ICD) trong API analysis, đảm bảo thông tin trả về đầy đủ chapter và official name.

4.  **Trạng thái triển khai (Section VI):**
    *   **Verify thành công:** Đã chạy script test và xác nhận hệ thống xử lý đúng các case: thuốc trùng SĐK, thuốc không tìm thấy (AI suy luận) và bệnh lý có/không có trong DB.

**Kết luận:** PRD đã bao quát tốt các yêu cầu nghiệp vụ. Đề xuất cập nhật lại bảng Selector ở Section IV để khớp với thực tế.