# [REPORT] DRUG IDENTIFICATION SYSTEM - ARCHITECTURE & IMPLEMENTATION
**Date:** 2026-01-09
**Status:** Completed (System Rebuilding)
**Author:** AI Agent (Scientist Persona)

---

## 1. Executive Summary (TÃ³m táº¯t Ä‘iá»u hÃ nh)
Dá»± Ã¡n Ä‘Ã£ thá»±c hiá»‡n má»™t bÆ°á»›c nháº£y vá»t quan trá»ng trong ngÃ y 09/01/2026. Tá»« viá»‡c xá»­ lÃ½ cÃ¡c file dá»¯ liá»‡u nhá» láº», há»‡ thá»‘ng Ä‘Ã£ tiáº¿p nháº­n vÃ  khai thÃ¡c thÃ nh cÃ´ng "Kho bÃ¡u" dá»¯ liá»‡u (DataCore), nÃ¢ng tá»•ng sá»‘ lÆ°á»£ng thuá»‘c trong cÆ¡ sá»Ÿ dá»¯ liá»‡u lÃªn gáº¥p **25 láº§n** (tá»« ~2,600 lÃªn **65,026** thuá»‘c).

Äá»“ng thá»i, thuáº­t toÃ¡n tÃ¬m kiáº¿m (Search Engine) Ä‘Ã£ Ä‘Æ°á»£c nÃ¢ng cáº¥p toÃ n diá»‡n (Task 018) Ä‘á»ƒ tÃ­ch há»£p kháº£ nÄƒng **Fuzzy Matching** (báº¯t lá»—i chÃ­nh táº£) vÃ  **Vector Search** (tÃ¬m kiáº¿m ngá»¯ nghÄ©a), Ä‘áº£m báº£o tá»‘c Ä‘á»™ pháº£n há»“i dÆ°á»›i 1 giÃ¢y cho 99% cÃ¡c truy váº¥n ná»™i bá»™.

---

## 2. Data Pipeline Architecture (Kiáº¿n trÃºc Dá»¯ liá»‡u)

### 2.1. Nguá»“n dá»¯ liá»‡u (DataCore)
- **Input:** 08 file CSV tá»« thÆ° má»¥c `datacore_thuocbietduoc` (Tá»•ng dung lÆ°á»£ng ~43MB).
- **Raw Volume:** 83,770 dÃ²ng dá»¯ liá»‡u thÃ´.

### 2.2. Quy trÃ¬nh Xá»­ lÃ½ (Data Refinery)
Äá»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng dá»¯a liá»‡u, module `DataRefinery` Ä‘Ã£ thá»±c hiá»‡n:
1.  **Consolidation:** Há»£p nháº¥t táº¥t cáº£ cÃ¡c nguá»“n dá»¯ liá»‡u rá»i ráº¡c.
2.  **Cleaning:** Chuáº©n hÃ³a vÄƒn báº£n, loáº¡i bá» kÃ½ tá»± rÃ¡c.
3.  **Deduplication:** Khá»­ trÃ¹ng láº·p dá»±a trÃªn **Sá»‘ ÄÄƒng KÃ½ (SDK)**, Æ°u tiÃªn giá»¯ láº¡i báº£n ghi cÃ³ Ä‘áº§y Ä‘á»§ thÃ´ng tin nháº¥t (Completeness Score).
4.  **Schema Migration:** Tá»± Ä‘á»™ng má»Ÿ rá»™ng cáº¥u trÃºc báº£ng `drugs` (thÃªm cá»™t `source_urls`) Ä‘á»ƒ lÆ°u trá»¯ nguá»“n gá»‘c dá»¯ liá»‡u.

### 2.3. Chiáº¿n lÆ°á»£c Import (Smart Upsert)
Äá»ƒ nháº­p 65,000 báº£n ghi vÃ o SQLite mÃ  khÃ´ng gÃ¢y treo há»‡ thá»‘ng:
- **Ká»¹ thuáº­t:** Sá»­ dá»¥ng **In-memory Indexing** (táº£i trÆ°á»›c hash map cá»§a SDK) Ä‘á»ƒ kiá»ƒm tra trÃ¹ng láº·p tá»©c thÃ¬, thay vÃ¬ thá»±c hiá»‡n 80,000 cÃ¢u lá»‡nh `SELECT`.
- **Logic:**
    - Náº¿u thuá»‘c chÆ°a cÃ³ -> `INSERT`.
    - Náº¿u thuá»‘c Ä‘Ã£ cÃ³ -> `UPDATE` (chá»‰ Ä‘iá»n cÃ¡c thÃ´ng tin cÃ²n thiáº¿u nhÆ° chá»‰ Ä‘á»‹nh, note).
- **Káº¿t quáº£:**
    - ThÃªm má»›i: **62,406** thuá»‘c.
    - Cáº­p nháº­t: **89** thuá»‘c.
    - Thá»i gian thá»±c thi: < 2 phÃºt.

---

## 3. Search Engine Algorithm (Thuáº­t toÃ¡n TÃ¬m kiáº¿m)

Há»‡ thá»‘ng sá»­ dá»¥ng kiáº¿n trÃºc tÃ¬m kiáº¿m Ä‘a táº§ng (Multi-stage Hybrid Search) Ä‘á»ƒ cÃ¢n báº±ng giá»¯a Tá»‘c Ä‘á»™ vÃ  Äá»™ chÃ­nh xÃ¡c.

### CÃ¡c táº§ng tÃ¬m kiáº¿m (Priority Order):

**1. Exact Match (SQL)**
- **MÃ´ táº£:** TÃ¬m kiáº¿m chÃ­nh xÃ¡c tÃªn thuá»‘c theo Index DB.
- **Tá»‘c Ä‘á»™:** **~0.06s**.
- **Äá»™ tin cáº­y:** Tuyá»‡t Ä‘á»‘i (1.0).

**2. Partial Match (SQL LIKE)**
- **MÃ´ táº£:** TÃ¬m kiáº¿m chuá»—i con (Substring).

**3. Fuzzy Match (RapidFuzz)** [ğŸŒŸ UPGRADE]
- **MÃ´ táº£:** Sá»­ dá»¥ng thuáº­t toÃ¡n Levenshtein Distance Ä‘á»ƒ báº¯t lá»—i chÃ­nh táº£.
- **VÃ­ dá»¥:** Input *"Paretamol"* -> TÃ¬m tháº¥y *"Paracetamol"*.
- **Threshold:** Score >= 85.

**4. Vector Search (TF-IDF)** [ğŸŒŸ OPTIMIZED]
- **MÃ´ táº£:** TÃ¬m kiáº¿m dá»±a trÃªn Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng vector (Semantic).
- **VÃ­ dá»¥:** Input *"Tra Hoang Bach Phong"* -> TÃ¬m tháº¥y *"TrÃ  HoÃ ng Báº¡ch Phong..."*.
- **Tá»‘i Æ°u hÃ³a (Task 018):**
    - **Index Cleaning:** Loáº¡i bá» SDK khá»i search index Ä‘á»ƒ trÃ¡nh lÃ m nhiá»…u vector.
    - **Threshold Tuning:** Háº¡ ngÆ°á»¡ng cháº¥p nháº­n tá»« 0.85 xuá»‘ng **0.75**.

**5. Web Search Fallback (Playwright/Google)**
- **MÃ´ táº£:** Lá»›p báº£o vá»‡ cuá»‘i cÃ¹ng. Náº¿u DB khÃ´ng tÃ¬m tháº¥y, há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng tÃ¬m trÃªn Google/ThuocBietDuoc.
- **Tá»‘c Ä‘á»™:** ~30-60s (Cháº­m, chá»‰ dÃ¹ng khi cáº§n thiáº¿t).

---

## 4. Technical Implementation Details

### File cáº¥u trÃºc:
- `scripts/run_import_datacore.py`: Script xá»­ lÃ½ DataCore & Import DB.
- `app/services.py`: Chá»©a logic `search_drug_smart` má»›i (tÃ­ch há»£p RapidFuzz).
- `requirements.txt`: ThÃªm dependency `rapidfuzz`.

### Docker Environment:
- Há»‡ thá»‘ng Ä‘ang Ä‘Æ°á»£c rebuild (`docker-compose build`) Ä‘á»ƒ náº¡p cÃ¡c dependencies xá»­ lÃ½ vÄƒn báº£n vÃ  trÃ¬nh duyá»‡t.

---

## 5. Káº¿t luáº­n & Äá» xuáº¥t

Há»‡ thá»‘ng hiá»‡n táº¡i Ä‘Ã£ chuyá»ƒn mÃ¬nh tá»« má»™t cÃ´ng cá»¥ tra cá»©u cÆ¡ báº£n thÃ nh má»™t **Kho tri thá»©c Y khoa (Medical Knowledge Base)** thá»±c thá»¥ vá»›i 65,000 Ä‘áº§u thuá»‘c.

**BÆ°á»›c tiáº¿p theo:**
1.  Äá»£i quÃ¡ trÃ¬nh Rebuild Docker hoÃ n táº¥t (Ä‘ang cháº¡y).
2.  Sá»­ dá»¥ng `scripts/benchmark_search.py` Ä‘á»ƒ kiá»ƒm tra hiá»‡u nÄƒng Ä‘á»‹nh ká»³.
3.  CÃ¢n nháº¯c chuyá»ƒn sang Vector DB chuyÃªn dá»¥ng (Qdrant/Chroma) náº¿u dá»¯ liá»‡u vÆ°á»£t quÃ¡ 100,000 báº£n ghi Ä‘á»ƒ giáº£m táº£i RAM cho In-memory caching.

---
*Report generated by AI Assistant.*
