name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # Since the runner is ON the server, we can run commands directly.
      # However, we want to update the EXISTING deployment folder, not just the runner's workspace.
      - name: Deploy to /root/workspace
        run: |
          # Safety: Isolate this project to avoid conflicts and allow root operations
          # Migration: Cleanup LEGACY container to free port 8000
          docker rm -f drug_icd_mapping_web_1 || true
          
          export RUNNER_ALLOW_RUNASROOT=1
          export HOME=/root
          export COMPOSE_PROJECT_NAME=drug_icd_mapping_prod
          
          TARGET_DIR="/root/workspace/drug_icd_mapping/fastapi-medical-app"
          
          echo "Deploying to $TARGET_DIR"
          cd $TARGET_DIR
          
          echo "1. Pulling latest code..."
          git config --global --add safe.directory $TARGET_DIR
          git pull origin main
          
          echo "2. Rebuilding Container..."
          cp Dockerfile.prod Dockerfile
          # Workaround for docker-compose 1.29 KeyError: 'ContainerConfig'
          docker-compose rm -f -s web || true
          docker-compose up -d --build --no-deps web
          
          echo ">>> DEPLOYMENT SUCCESSFUL <<<"
          docker-compose ps
