# TÃ i liá»‡u hÆ°á»›ng dáº«n: Logic mapping Category, Validity vÃ  Role

## âŒ Váº¥n Ä‘á» hiá»‡n táº¡i

### Request:

```bash
curl -X 'POST' \
  'http://10.14.190.28:8000/api/v1/consult_integrated' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "diagnoses": [
    {
      "code": "J00",
      "name": "ViÃªm mÅ©i há»ng cáº¥p [cáº£m thÆ°á»ng]",
      "type": "MAIN"
    }
  ],
  "items": [
    {
      "id": "916b023e-a5cb-4e8e-b0d4-309f2d02d778",
      "name": "natriclorid srk saltmax 0 45g 50ml x 100ml"
    }
  ],
  "request_id": "BT/24594",
  "symptom": "ViÃªm Ä‘Æ°á»ng hÃ´ háº¥p - ViÃªm mÅ©i há»ng cáº¥p - Nhiá»…m RSV"
}'
```

### Output SAI:

```json
{
  "results": [
    {
      "id": "916b023e-a5cb-4e8e-b0d4-309f2d02d778",
      "name": "natriclorid srk saltmax 0 45g 50ml x 100ml",
      "category": "drug",          // âŒ SAI
      "validity": "valid",
      "role": "medical equipment",
      "explanation": "Expert Verified: Classified as 'medical equipment' bá»Ÿi TÄV. (Match: exact)",
      "source": "INTERNAL_KB_TDV"
    }
  ]
}
```

 **Lá»—i** : `role: medical equipment` â†’ `category` PHáº¢I lÃ  `nodrug`, khÃ´ng thá»ƒ lÃ  `drug`

---

## âœ… Quy táº¯c mapping TUYá»†T Äá»I

### 1. Cáº¥u trÃºc phÃ¢n cáº¥p

```
Sáº£n pháº©m
â”œâ”€â”€ category: drug
â”‚   â”œâ”€â”€ validity: invalid â†’ KHÃ”NG cÃ³ role
â”‚   â””â”€â”€ validity: valid
â”‚       â”œâ”€â”€ role: main drug
â”‚       â””â”€â”€ role: secondary drug
â”‚
â””â”€â”€ category: nodrug
    â”œâ”€â”€ validity: "" (Ä‘á»ƒ trá»‘ng)
    â””â”€â”€ role:
        â”œâ”€â”€ supplement
        â”œâ”€â”€ cosmeceuticals
        â””â”€â”€ medical equipment
```

---

### 2. CÃ¡c quy táº¯c Báº®T BUá»˜C

#### Rule 1: Category xÃ¡c Ä‘á»‹nh bá»Ÿi Role

| Role                  | Category   | Validity       |
| --------------------- | ---------- | -------------- |
| `main drug`         | `drug`   | `valid`      |
| `secondary drug`    | `drug`   | `valid`      |
| (khÃ´ng cÃ³ role)     | `drug`   | `invalid`    |
| `supplement`        | `nodrug` | `""`(trá»‘ng) |
| `cosmeceuticals`    | `nodrug` | `""`(trá»‘ng) |
| `medical equipment` | `nodrug` | `""`(trá»‘ng) |

#### Rule 2: CÃ¡c tá»• há»£p Há»¢P Lá»†

âœ… **Cho phÃ©p:**

```json
{"category": "drug", "validity": "invalid"}  // KhÃ´ng cÃ³ role
{"category": "drug", "validity": "valid", "role": "main drug"}
{"category": "drug", "validity": "valid", "role": "secondary drug"}
{"category": "nodrug", "validity": "", "role": "supplement"}
{"category": "nodrug", "validity": "", "role": "cosmeceuticals"}
{"category": "nodrug", "validity": "", "role": "medical equipment"}
```

âŒ **Cáº¤M tuyá»‡t Ä‘á»‘i:**

```json
{"category": "drug", "role": "medical equipment"}      // SAI
{"category": "drug", "role": "supplement"}             // SAI
{"category": "drug", "role": "cosmeceuticals"}         // SAI
{"category": "nodrug", "role": "main drug"}            // SAI
{"category": "nodrug", "role": "secondary drug"}       // SAI
{"category": "nodrug", "validity": "valid"}            // SAI
{"category": "nodrug", "validity": "invalid"}          // SAI
{"category": "drug", "validity": "invalid", "role": "..."} // SAI - invalid khÃ´ng cÃ³ role
```

---

## ğŸ”§ Giáº£i phÃ¡p

### 1. File tham chiáº¿u

```
C:\Users\Admin\Desktop\drug_icd_mapping\knowledge for agent\logs_to_database\group_definitions.md
```

### 2. NÃ¢ng cáº¥p code cáº§n thá»±c hiá»‡n

#### A. ThÃªm validation logic

```python
def validate_mapping(category, validity, role):
    """
    Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a mapping
    """
    # Rule 1: role thuá»™c nodrug
    if role in ["supplement", "cosmeceuticals", "medical equipment"]:
        assert category == "nodrug", f"Role '{role}' pháº£i cÃ³ category='nodrug'"
        assert validity == "", f"Role '{role}' pháº£i cÃ³ validity trá»‘ng"
  
    # Rule 2: role thuá»™c drug
    if role in ["main drug", "secondary drug"]:
        assert category == "drug", f"Role '{role}' pháº£i cÃ³ category='drug'"
        assert validity == "valid", f"Role '{role}' pháº£i cÃ³ validity='valid'"
  
    # Rule 3: drug invalid khÃ´ng cÃ³ role
    if category == "drug" and validity == "invalid":
        assert role is None or role == "", "Drug invalid khÃ´ng Ä‘Æ°á»£c cÃ³ role"
  
    return True
```

#### B. Auto-correction logic

```python
def auto_correct_mapping(category, validity, role):
    """
    Tá»± Ä‘á»™ng sá»­a mapping dá»±a trÃªn role
    """
    # Æ¯u tiÃªn role lÃ m nguá»“n sá»± tháº­t
    if role in ["supplement", "cosmeceuticals", "medical equipment"]:
        return "nodrug", "", role
  
    if role in ["main drug", "secondary drug"]:
        return "drug", "valid", role
  
    # Náº¿u khÃ´ng cÃ³ role
    if category == "drug":
        return "drug", validity or "invalid", None
  
    return category, validity, role
```

---

## ğŸ¤– Prompt cho AI

### ThÃªm vÃ o system prompt:

```markdown
## MAPPING RULES - TUYá»†T Äá»I TUÃ‚N THá»¦

Báº¡n sáº½ nháº­n Ä‘Æ°á»£c káº¿t quáº£ tá»« 2 nguá»“n:
1. AI classification
2. Expert verification (Tháº©m Ä‘á»‹nh viÃªn - TÄV)

### NguyÃªn táº¯c Æ°u tiÃªn:
- **Expert verification > AI classification**
- Náº¿u TÄV khÃ´ng feedback â†’ AI classification Ä‘Æ°á»£c coi lÃ  chÃ­nh xÃ¡c
- Náº¿u nhiá»u TÄV cÃ³ feedback khÃ¡c nhau â†’ suy luáº­n Ä‘á»ƒ chá»n káº¿t quáº£ tá»‘t nháº¥t

### Quy táº¯c mapping Báº®T BUá»˜C:

1. **Thuá»‘c (drug)**:
   - `category: drug` + `validity: invalid` â†’ KHÃ”NG cÃ³ `role`
   - `category: drug` + `validity: valid` + `role: main drug`
   - `category: drug` + `validity: valid` + `role: secondary drug`

2. **KhÃ´ng pháº£i thuá»‘c (nodrug)**:
   - `category: nodrug` + `validity: ""` + `role: supplement`
   - `category: nodrug` + `validity: ""` + `role: cosmeceuticals`
   - `category: nodrug` + `validity: ""` + `role: medical equipment`

### âŒ Cáº¤M TUYá»†T Äá»I:
- `category: drug` + `role: medical equipment` â†’ SAI
- `category: drug` + `role: supplement` â†’ SAI
- `category: nodrug` + `role: main drug` â†’ SAI
- `category: nodrug` + `validity: valid/invalid` â†’ SAI

### Validation workflow:
1. Nháº­n káº¿t quáº£ tá»« AI vÃ  TÄV
2. Náº¿u cÃ³ TÄV feedback â†’ sá»­ dá»¥ng TÄV lÃ m nguá»“n sá»± tháº­t
3. Kiá»ƒm tra role
4. Tá»± Ä‘á»™ng sá»­a category vÃ  validity dá»±a trÃªn role
5. Äáº£m báº£o output tuÃ¢n thá»§ 100% quy táº¯c trÃªn
```

---

## ğŸ“‹ Checklist kiá»ƒm tra

TrÆ°á»›c khi output, AI pháº£i tá»± kiá»ƒm tra:

* [ ] Náº¿u `role` lÃ  `medical equipment/supplement/cosmeceuticals` â†’ `category` PHáº¢I lÃ  `nodrug`
* [ ] Náº¿u `role` lÃ  `main drug/secondary drug` â†’ `category` PHáº¢I lÃ  `drug` vÃ  `validity` PHáº¢I lÃ  `valid`
* [ ] Náº¿u `category` lÃ  `drug` vÃ  `validity` lÃ  `invalid` â†’ KHÃ”NG Ä‘Æ°á»£c cÃ³ `role`
* [ ] Náº¿u `category` lÃ  `nodrug` â†’ `validity` PHáº¢I trá»‘ng
* [ ] KhÃ´ng tá»“n táº¡i báº¥t ká»³ tá»• há»£p cáº¥m nÃ o

---

## ğŸ“ Output máº«u ÄÃšNG

### VÃ­ dá»¥ 1: Medical equipment

```json
{
  "category": "nodrug",
  "validity": "",
  "role": "medical equipment"
}
```

### VÃ­ dá»¥ 2: Main drug

```json
{
  "category": "drug",
  "validity": "valid",
  "role": "main drug"
}
```

### VÃ­ dá»¥ 3: Invalid drug

```json
{
  "category": "drug",
  "validity": "invalid"
}
```
