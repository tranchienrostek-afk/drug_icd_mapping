<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Knowledge Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .page-link {
            cursor: pointer;
        }

        .tab-content {
            padding-top: 20px;
        }

        .truncate-text {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>

<body>

    <!-- Loading Spinner -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container mt-4">
        <h1 class="mb-4 text-primary">üè• Medical Knowledge Base Admin</h1>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="drugs-tab" data-bs-toggle="tab" data-bs-target="#drugs"
                    type="button" role="tab" onclick="loadPage('drugs')">üíä Thu·ªëc (Drugs)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="diseases-tab" data-bs-toggle="tab" data-bs-target="#diseases" type="button"
                    role="tab" onclick="loadPage('diseases')">ü¶† B·ªánh (Diseases)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button"
                    role="tab" onclick="loadPage('links')">üîó M·ªëi Li√™n H·ªá (Knowledge)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="staging-tab" data-bs-toggle="tab" data-bs-target="#staging" type="button"
                    role="tab">üöß Ki·ªÉm Duy·ªát (Staging)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button"
                    role="tab" onclick="loadPage('system')">üìà System Status</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">

            <!-- DRUGS TAB -->
            <div class="tab-pane fade show active" id="drugs" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="search-drugs" placeholder="T√¨m t√™n thu·ªëc, SƒêK..."
                            onkeyup="handleSearch('drugs', event)">
                    </div>
                    <div class="col-md-7 text-end">
                        <button class="btn btn-primary me-2" onclick="loadData('drugs')">T√¨m ki·∫øm</button>
                        <button class="btn btn-success" onclick="openDrugModal()">+ Th√™m Thu·ªëc</button>
                        <span class="ms-2 fw-bold text-secondary">T·ªïng: <span id="total-drugs">0</span></span>
                    </div>
                </div>

                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>T√™n Thu·ªëc</th>
                            <th>SƒêK</th>
                            <th>Ho·∫°t Ch·∫•t</th>
                            <th>Ch·ªâ ƒê·ªãnh</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th style="width: 120px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-drugs-body"></tbody>
                </table>

                <nav>
                    <ul class="pagination justify-content-center" id="pagination-drugs"></ul>
                </nav>
            </div>

            <!-- DISEASES TAB -->
            <div class="tab-pane fade" id="diseases" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="search-diseases" placeholder="T√¨m t√™n b·ªánh, ICD..."
                            onkeyup="handleSearch('diseases', event)">
                    </div>
                    <div class="col-md-7 text-end">
                        <button class="btn btn-primary me-2" onclick="loadData('diseases')">T√¨m ki·∫øm</button>
                        <button class="btn btn-success" onclick="openDiseaseModal()">+ Th√™m B·ªánh</button>
                        <span class="ms-2 fw-bold text-secondary">T·ªïng: <span id="total-diseases">0</span></span>
                    </div>
                </div>

                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>M√£ ICD</th>
                            <th>T√™n B·ªánh</th>
                            <th>Chapter / Ph√¢n Lo·∫°i</th>
                            <th class="text-center" style="width: 100px;">T·∫ßn Su·∫•t</th>
                            <th style="width: 120px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-diseases-body"></tbody>
                </table>

                <nav>
                    <ul class="pagination justify-content-center" id="pagination-diseases"></ul>
                </nav>
            </div>

            <!-- LINKS TAB -->
            <div class="tab-pane fade" id="links" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-links" placeholder="T√¨m li√™n k·∫øt..."
                            onkeyup="handleSearch('links', event)">
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary me-2" onclick="loadData('links')">T√¨m ki·∫øm</button>
                        <button class="btn btn-success" onclick="openLinkModal()">+ Th√™m Li√™n K·∫øt</button>
                        <span class="ms-2 fw-bold text-secondary">T·ªïng: <span id="total-links">0</span></span>
                    </div>
                </div>

                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Thu·ªëc (Drug)</th>
                            <th>B·ªánh (Disease)</th>
                            <th>B·ªánh Ph·ª• & Ch·∫©n ƒëo√°n</th>
                            <th>Ph√¢n Lo·∫°i & L√Ω do</th>
                            <th class="text-center" style="width: 80px;">T·∫ßn su·∫•t</th>
                            <th class="text-center" style="width: 100px;">Tr·∫°ng Th√°i</th>
                            <th class="text-center" style="width: 80px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-links-body"></tbody>
                </table>

                <nav>
                    <ul class="pagination justify-content-center" id="pagination-links"></ul>
                </nav>
            </div>

            <!-- STAGING TAB -->
            <div class="tab-pane fade" id="staging" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Danh S√°ch Ch·ªù Duy·ªát</h4>
                    <div>
                        <button class="btn btn-warning me-2" onclick="clearAllStaging()">D·ªçn d·∫πp (Clear All)</button>
                        <button class="btn btn-primary" onclick="loadData('staging')">L√†m m·ªõi</button>
                    </div>
                </div>
                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>T√™n Thu·ªëc (M·ªõi)</th>
                            <th>Xung ƒê·ªôt V·ªõi</th>
                            <th>Ng∆∞·ªùi Y√™u C·∫ßu</th>
                            <th>Th·ªùi Gian</th>
                            <th style="width: 150px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-staging-body"></tbody>
                </table>
            </div>

            <!-- SYSTEM STATUS TAB -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h4 class="text-primary">üìä Dashboard & System Health</h4>
                    <button class="btn btn-primary btn-sm" onclick="loadData('system')">üîÑ Refresh</button>
                </div>

                <!-- API Cards -->
                <div class="row mb-4" id="api-stats-container">
                    <div class="col text-center py-5">
                        <div class="spinner-border text-secondary"></div>
                    </div>
                </div>

                <!-- Ingestion History -->
                <div class="card">
                    <div class="card-header bg-light fw-bold">üì• L·ªãch S·ª≠ Import (CSV Batches)</div>
                    <div class="card-body p-0">
                        <table class="table table-bordered table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Batch ID</th>
                                    <th>Th·ªùi gian Ho√†n Th√†nh</th>
                                    <th class="text-center">S·ªë D√≤ng</th>
                                    <th class="text-center">Unique Drugs</th>
                                    <th class="text-center">Unique Diseases</th>
                                </tr>
                            </thead>
                            <tbody id="table-system-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- LINK KNOWLEDGE MODAL -->
    <div class="modal fade" id="linkKnowledgeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m/S·ª≠a M·ªëi Li√™n H·ªá (Knowledge Link)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="linkForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Lo·∫°i Chi Tr·∫£ (Coverage)</label>
                                <select class="form-select" id="link-coverage">
                                    <option value="Thu·ªëc ƒëi·ªÅu tr·ªã">Thu·ªëc ƒëi·ªÅu tr·ªã</option>
                                    <option value="Thu·ªëc h·ªó tr·ª£">Thu·ªëc h·ªó tr·ª£</option>
                                    <option value="Thu·ªëc kh√¥ng ƒëi·ªÅu tr·ªã">Thu·ªëc kh√¥ng ƒëi·ªÅu tr·ªã</option>
                                    <option value="T·ª´ ch·ªëi chi tr·∫£">T·ª´ ch·ªëi chi tr·∫£</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tr·∫°ng Th√°i X√°c Th·ª±c</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="link-verified" checked>
                                    <label class="form-check-label">ƒê√£ x√°c th·ª±c (Verified)</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">M√£ Thu·ªëc (SDK) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="link-sdk" required
                                    placeholder="VD: VD-12345-67">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">T√™n Thu·ªëc (Reference)</label>
                                <input type="text" class="form-control" id="link-drug-name"
                                    placeholder="Nh·∫≠p t√™n ƒë·ªÉ t·∫°o Staging n·∫øu ch∆∞a c√≥">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">M√£ B·ªánh (ICD) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="link-icd" required placeholder="VD: A00.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">T√™n B·ªánh (Reference)</label>
                                <input type="text" class="form-control" id="link-disease-name" placeholder="T√™n b·ªánh">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi Ch√∫ ƒêi·ªÅu Tr·ªã (Treatment Note)</label>
                            <textarea class="form-control" id="link-note" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveLink()">L∆∞u Li√™n K·∫øt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DRUG MODAL -->
    <div class="modal fade" id="drugModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drugModalTitle">Th√™m/S·ª≠a Thu·ªëc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="drugForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">S·ªë ƒêƒÉng K√Ω (SƒêK) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="drug_sdk" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">T√™n Thu·ªëc <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="drug_name" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ho·∫°t Ch·∫•t</label>
                            <input type="text" class="form-control" id="drug_ingredient">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">C√¥ng Ty S·∫£n Xu·∫•t</label>
                            <input type="text" class="form-control" id="drug_company">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ch·ªâ ƒê·ªãnh / C√¥ng D·ª•ng</label>
                            <textarea class="form-control" id="drug_usage" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T·ª´ ƒê·ªìng Nghƒ©a (ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y)</label>
                            <input type="text" class="form-control" id="drug_synonyms"
                                placeholder="V√≠ d·ª•: Panadol ƒë·ªè, Thu·ªëc ƒëau ƒë·∫ßu">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ph√¢n Lo·∫°i</label>
                                <select class="form-select" id="drug_classification">
                                    <option value="Thu·ªëc">Thu·ªëc</option>
                                    <option value="Vitamin/thu·ªëc b·ªï">Vitamin/thu·ªëc b·ªï</option>
                                    <option value="Th·ª±c ph·∫©m ch·ª©c nƒÉng">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                                    <option value="Thi·∫øt b·ªã y t·∫ø">Thi·∫øt b·ªã y t·∫ø</option>
                                    <option value="">Kh√°c/Ch∆∞a r√µ</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi Ch√∫ (Th·∫©m ƒë·ªãnh vi√™n)</label>
                            <textarea class="form-control" id="drug_note" rows="2"
                                placeholder="Ghi ch√∫ quan tr·ªçng cho AI..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveDrug()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STAGING EDIT MODAL -->
    <div class="modal fade" id="stagingEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ch·ªânh S·ª≠a Staging</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stagingEditForm">
                        <input type="hidden" id="staging_edit_id">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">S·ªë ƒêƒÉng K√Ω</label>
                                <input type="text" class="form-control" id="staging_edit_sdk">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">T√™n Thu·ªëc</label>
                                <input type="text" class="form-control" id="staging_edit_name">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ho·∫°t Ch·∫•t</label>
                            <input type="text" class="form-control" id="staging_edit_ingredient">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">C√¥ng Ty S·∫£n Xu·∫•t</label>
                            <input type="text" class="form-control" id="staging_edit_company">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ch·ªâ ƒê·ªãnh</label>
                            <textarea class="form-control" id="staging_edit_usage" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T·ª´ ƒê·ªìng Nghƒ©a</label>
                            <input type="text" class="form-control" id="staging_edit_synonyms">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ph√¢n Lo·∫°i</label>
                                <select class="form-select" id="staging_edit_classification">
                                    <option value="Thu·ªëc">Thu·ªëc</option>
                                    <option value="Vitamin/thu·ªëc b·ªï">Vitamin/thu·ªëc b·ªï</option>
                                    <option value="Th·ª±c ph·∫©m ch·ª©c nƒÉng">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                                    <option value="Thi·∫øt b·ªã y t·∫ø">Thi·∫øt b·ªã y t·∫ø</option>
                                    <option value="">Kh√°c/Ch∆∞a r√µ</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi Ch√∫</label>
                            <textarea class="form-control" id="staging_edit_note" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveStagingEdit()">C·∫≠p Nh·∫≠t</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStagingItemInModal()">T·ª´ Ch·ªëi (Move to
                        History)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DISEASE MODAL -->
    <div class="modal fade" id="diseaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="diseaseModalTitle">Th√™m/S·ª≠a B·ªánh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="diseaseForm">
                        <div class="mb-3">
                            <label class="form-label">M√£ ICD <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="disease_icd" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T√™n B·ªánh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="disease_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ch∆∞∆°ng (Chapter)</label>
                            <input type="text" class="form-control" id="disease_chapter">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveDisease()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- COMPARISON MODAL -->
    <div class="modal fade" id="compareModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">So S√°nh & Duy·ªát Th√¥ng Tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- OLD DATA -->
                        <div class="col-md-6 border-end">
                            <h6 class="text-secondary fw-bold text-center">D·ªØ Li·ªáu Hi·ªán T·∫°i (DB)</h6>
                            <div id="compare-left" class="p-3 bg-light rounded">
                                <em>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c≈© (T·∫°o m·ªõi)</em>
                            </div>
                        </div>
                        <!-- NEW DATA -->
                        <div class="col-md-6">
                            <h6 class="text-primary fw-bold text-center">D·ªØ Li·ªáu M·ªõi (Staging)</h6>
                            <div id="compare-right" class="p-3 bg-light rounded border border-primary"></div>
                        </div>
                    </div>
                    <div id="alert-conflict-type" class="alert alert-warning mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">T·ª´ Ch·ªëi</button>
                    <button type="button" class="btn btn-success" onclick="confirmApprove()">‚úÖ Ph√™ Duy·ªát</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Logic -->
    <script>
        const API_BASE = '/api/v1/admin';
        const STAGING_API = '/api/v1/drugs/admin'; // Base for staging endpoints
        const DRUG_API = '/api/v1/drugs';
        const PAGE_LIMIT = 20;

        let currentPage = { drugs: 1, diseases: 1, links: 1 };
        let currentSearch = { drugs: "", diseases: "", links: "" };
        let currentStagingId = null;

        // Modals
        let drugModal, diseaseModal, compareModal, stagingEditModal;

        document.addEventListener('DOMContentLoaded', () => {
            drugModal = new bootstrap.Modal(document.getElementById('drugModal'));
            diseaseModal = new bootstrap.Modal(document.getElementById('diseaseModal'));
            compareModal = new bootstrap.Modal(document.getElementById('compareModal'));
            stagingEditModal = new bootstrap.Modal(document.getElementById('stagingEditModal'));

            // Event Listeners
            document.getElementById('staging-tab').addEventListener('click', () => loadPage('staging'));

            loadData('drugs');
        });

        // --- LOAD DATA ---
        function loadPage(type) {
            console.log("loadPage called for:", type);
            loadData(type);
        }

        function handleSearch(type, event) {
            if (event.key === 'Enter') loadData(type);
        }

        async function loadData(type) {
            const tableBody = document.getElementById(`table-${type}-body`);
            const searchInputEl = document.getElementById(`search-${type}`);
            const searchInput = searchInputEl ? searchInputEl.value : "";
            const pagination = document.getElementById(`pagination-${type}`);
            const spinner = document.getElementById('loadingOverlay');

            currentSearch[type] = searchInput;
            spinner.style.display = 'flex';
            tableBody.innerHTML = '';

            try {
                let url;
                if (type === 'staging') {
                    url = `${STAGING_API}/staging`;
                } else if (type === 'system') {
                    url = `${API_BASE}/monitor/stats?days=1`;
                } else {
                    url = `${API_BASE}/${type}?page=${currentPage[type]}&limit=${PAGE_LIMIT}&search=${encodeURIComponent(currentSearch[type])}`;
                }

                const response = await fetch(url);

                let data;
                if (type === 'staging') {
                    data = await response.json();
                    renderTable(type, data);
                    renderPagination(type, 0, pagination);
                } else if (type === 'system') {
                    data = await response.json();
                    renderSystemStats(data);
                } else {
                    const result = await response.json();

                    // Update Totals
                    if (result.total !== undefined) {
                        if (type === 'diseases') {
                            const tDiv = document.getElementById('total-diseases');
                            if (tDiv) tDiv.innerText = result.total;
                        }
                        if (type === 'drugs') {
                            const tDiv = document.getElementById('total-drugs');
                            if (tDiv) tDiv.innerText = result.total;
                        }
                        if (type === 'links') {
                            const tDiv = document.getElementById('total-links');
                            if (tDiv) tDiv.innerText = result.total;
                        }
                    }

                    renderTable(type, result.data);
                    renderPagination(type, result.total, pagination);
                }

            } catch (error) {
                console.error("Error loading data:", error);
            } finally {
                spinner.style.display = 'none';
            }
        }
        function renderTable(type, data) {
            console.log(`Rendering table for ${type}, items: ${data ? data.length : 0}`);
            const tableBody = document.getElementById(`table-${type}-body`);
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>`;
                return;
            }

            let html = '';
            data.forEach(item => {
                // console.log("Processing item:", item); // Verbose
                if (type === 'drugs') {
                    const verified = item.is_verified === 1
                        ? '<span class="badge bg-success">Verified</span>'
                        : '<span class="badge bg-secondary">Scraped</span>';

                    // Encode item for onclick
                    const itemStr = encodeURIComponent(JSON.stringify(item));

                    html += `
                <tr>
                    <td class="fw-bold text-primary">${item.ten_thuoc || 'N/A'}</td>
                    <td><small>${item.so_dang_ky || 'N/A'}</small></td>
                    <td>${item.hoat_chat || ''}</td>
                    <td><span class="truncate-text" title="${item.chi_dinh || ''}">${item.chi_dinh || ''}</span></td>
                    <td>${verified}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="openDrugModal('${item.so_dang_ky}')">S·ª≠a</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('drugs', '${item.rowid}', true)">X√≥a</button>
                    </td>
                    <!-- Hidden Data Storage -->
                    <input type="hidden" id="drug-data-${item.so_dang_ky}" value="${itemStr}">
                </tr>
            `;
                } else if (type === 'diseases') {
                    const itemStr = encodeURIComponent(JSON.stringify(item));

                    // Parse chapter/treatment_type  
                    let chapterHTML = '';
                    const rawChapter = item.chapter_name || '';
                    if (rawChapter.startsWith('[')) {
                        // It's a JSON array from treatment_type
                        try {
                            const parts = JSON.parse(rawChapter);
                            chapterHTML = parts.map(p => `<span class="badge bg-secondary me-1">${p}</span>`).join('');
                        } catch (e) {
                            chapterHTML = `<span class="text-muted">${rawChapter}</span>`;
                        }
                    } else {
                        chapterHTML = rawChapter ? `<span class="badge bg-info text-dark">${rawChapter}</span>` : '<span class="text-muted">-</span>';
                    }

                    html += `
                <tr>
                    <td><span class="badge bg-primary fs-6">${item.icd_code || 'N/A'}</span></td>
                    <td class="fw-bold">${item.disease_name || 'N/A'}</td>
                    <td>${chapterHTML}</td>
                    <td class="text-center fw-bold fs-5 text-secondary">${item.frequency || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="openDiseaseModal('${item.icd_code}')">S·ª≠a</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('diseases', '${item.rowid}', true)">X√≥a</button>
                    </td>
                    <input type="hidden" id="disease-data-${item.icd_code}" value="${itemStr}">
                </tr>
            `;
                } else if (type === 'links') {
                    const verifiedBadge = item.is_verified
                        ? '<span class="badge bg-success">Verified</span>'
                        : '<span class="badge bg-secondary">Unverified</span>';

                    // Drug Column
                    const drugHTML = `
                        <div class="fw-bold text-primary">${item.drug_name || 'N/A'}</div>
                        ${item.sdk ? `<small class="text-muted">SDK: ${item.sdk}</small>` : ''}
                    `;

                    // Disease Column
                    const diseaseHTML = `
                        <div class="fw-bold">${item.disease_name || 'N/A'}</div>
                        <span class="badge bg-info text-dark">${item.icd_code || 'N/A'}</span>
                    `;

                    // Classification/Note
                    let classBadge = '<span class="badge bg-secondary">Unknown</span>';
                    const typeStr = (item.phan_loai || '').toLowerCase();

                    if (typeStr.includes('indicative') || typeStr.includes('main drug') || typeStr.includes('thu·ªëc ƒëi·ªÅu tr·ªã')) {
                        classBadge = '<span class="badge bg-success">ƒêi·ªÅu tr·ªã</span>';
                    }
                    else if (typeStr.includes('supportive') || typeStr.includes('secondary drug') || typeStr.includes('thu·ªëc h·ªó tr·ª£')) {
                        classBadge = '<span class="badge bg-info text-dark">H·ªó tr·ª£</span>';
                    }
                    else if (typeStr.includes('contraindication') || typeStr.includes('ch·ªëng ch·ªâ ƒë·ªãnh')) {
                        classBadge = '<span class="badge bg-danger">Ch·ªëng ch·ªâ ƒë·ªãnh</span>';
                    }

                    // Helper to format JSON like strings
                    const parseFeedback = (str) => {
                        if (!str) return '';
                        // Normalize if it looks like JSON array
                        if (str.startsWith('["')) {
                            try { return JSON.parse(str).filter(x => x !== 'valid').join(', '); } catch (e) { }
                        }
                        return str;
                    };

                    const classificationHTML = `
                        <div class="mb-1">${classBadge}</div>
                        ${item.tdv_feedback ? `<div class="badge bg-warning text-dark border border-dark" title="TDV Feedback">TDV: ${parseFeedback(item.tdv_feedback)}</div>` : ''}
                        ${item.prescription_reason ? `<div class="x-small text-muted mt-1" title="L√Ω do k√™ ƒë∆°n">üìù ${item.prescription_reason}</div>` : ''}
                        ${item.treatment_note ? `<div class="x-small text-muted mt-1"><em>"${item.treatment_note}"</em></div>` : ''}
                    `;

                    const secondaryInfo = `
                        ${item.symptom ? `<div class="text-danger x-small mb-1">ü§í ${item.symptom}</div>` : ''}
                        ${item.secondary_disease_icd ? `<div class="x-small text-muted">B·ªánh ph·ª•: <strong>${item.secondary_disease_icd}</strong> - ${item.secondary_disease_name || ''}</div>` : ''}
                    `;

                    html += `
                <tr>
                    <td>${drugHTML}</td>
                    <td>${diseaseHTML}</td>
                    <td>${secondaryInfo}</td>
                    <td>${classificationHTML}</td>
                    <td class="text-center fw-bold fs-5 text-secondary">${item.frequency || 1}</td>
                    <td class="text-center">${verifiedBadge}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLink('${item.sdk || ''}', '${item.icd_code}')" title="X√≥a li√™n k·∫øt">
                           üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
                } else if (type === 'staging') {
                    let conflictInfo = '<span class="badge bg-info">New Entry</span>';

                    if (item.conflict_id) {
                        console.log("Rendering conflict for item:", item.ten_thuoc, "Info:", item.conflict_info);
                        const conflictRaw = item.conflict_info
                            ? `<div class="fw-bold text-danger">${item.conflict_info.ten_thuoc}</div><small class="text-muted">ID: ${item.conflict_id} | ${item.conflict_info.so_dang_ky || ''}</small>`
                            : `<span class="badge bg-warning text-dark">Conflict ID: ${item.conflict_id}</span> <br><small class="text-secondary">(Th√¥ng tin g·ªëc ƒë√£ b·ªã x√≥a)</small>`;

                        conflictInfo = `<div><span class="badge bg-warning text-dark mb-1">Conflict: ${item.conflict_type || 'Unknown'}</span><br>${conflictRaw}</div>`;
                    }

                    // Prepare data for compare
                    const itemStr = encodeURIComponent(JSON.stringify(item));

                    html += `
                        <tr>
                            <td class="fw-bold">${item.ten_thuoc}</td>
                            <td>${conflictInfo}</td>
                            <td>${item.created_by || 'system'}</td>
                            <td>${item.created_at || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white me-1" onclick="openEditStaging('${itemStr}')">S·ª≠a</button>
                                <button class="btn btn-sm btn-primary" onclick="openCompare('${itemStr}')">Xem & Duy·ªát</button>
                            </td>
                        </tr>
                   `;
                }
            });
            tableBody.innerHTML = html;
        }

        // --- SYSTEM STATS RENDER ---
        function renderSystemStats(data) {
            const api = data.api || {};
            const ingestion = data.ingestion || [];

            // 1. Render Cards
            const statsContainer = document.getElementById('api-stats-container');
            const successRate = api.success_rate || 100;
            const cardColor = successRate > 95 ? 'success' : (successRate > 80 ? 'warning' : 'danger');

            statsContainer.innerHTML = `
                <div class="col-md-4">
                    <div class="card text-center border-primary shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted">API Requests (24h)</h5>
                            <p class="display-4 fw-bold text-primary mb-0">${api.total_requests || 0}</p>
                            <small class="text-muted">Total Consult Calls</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center border-${cardColor} shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Success Rate</h5>
                            <p class="display-4 fw-bold text-${cardColor} mb-0">${successRate}%</p>
                            <small class="text-muted">200 OK Responses</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center border-info shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Avg Latency</h5>
                            <p class="display-4 fw-bold text-info mb-0">${api.avg_latency || 0}<span class="fs-4">ms</span></p>
                            <small class="text-muted">Average Response Time</small>
                        </div>
                    </div>
                </div>
            `;

            // 2. Render Ingestion Table
            const tableBody = document.getElementById('table-system-body');
            if (ingestion.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu import n√†o</td></tr>`;
                return;
            }

            let html = '';
            ingestion.forEach(batch => {
                html += `
                    <tr>
                        <td>
                            <code class="text-dark bg-light px-2 py-1 rounded border">${batch.batch_id || 'N/A'}</code>
                        </td>
                        <td>${batch.completed_at || ''}</td>
                        <td class="text-center fw-bold">${batch.total_rows || 0}</td>
                        <td class="text-center">${batch.unique_drugs || 0}</td>
                        <td class="text-center">${batch.unique_diseases || 0}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        // ... [Pagination logic unchanged] ... 

        // [Existing functions...]

        // --- STAGING LOGIC ---

        function openEditStaging(itemStr) {
            const item = JSON.parse(decodeURIComponent(itemStr));
            document.getElementById('staging_edit_id').value = item.id;
            document.getElementById('staging_edit_sdk').value = item.so_dang_ky || '';
            document.getElementById('staging_edit_name').value = item.ten_thuoc || '';
            document.getElementById('staging_edit_ingredient').value = item.hoat_chat || '';
            document.getElementById('staging_edit_company').value = item.cong_ty_san_xuat || '';
            document.getElementById('staging_edit_usage').value = item.chi_dinh || '';
            document.getElementById('staging_edit_synonyms').value = item.tu_dong_nghia || '';
            document.getElementById('staging_edit_classification').value = item.classification || '';
            document.getElementById('staging_edit_note').value = item.note || '';

            stagingEditModal.show();
        }

        async function saveStagingEdit() {
            const id = document.getElementById('staging_edit_id').value;
            const data = {
                so_dang_ky: document.getElementById('staging_edit_sdk').value,
                ten_thuoc: document.getElementById('staging_edit_name').value,
                hoat_chat: document.getElementById('staging_edit_ingredient').value,
                cong_ty_san_xuat: document.getElementById('staging_edit_company').value,
                chi_dinh: document.getElementById('staging_edit_usage').value,
                tu_dong_nghia: document.getElementById('staging_edit_synonyms').value,
                classification: document.getElementById('staging_edit_classification').value,
                note: document.getElementById('staging_edit_note').value
            };

            try {
                const response = await fetch(`${STAGING_API}/staging/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    stagingEditModal.hide();
                    loadData('staging');
                } else {
                    const res = await response.json();
                    alert("L·ªói: " + res.detail);
                }
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi!"); }
        }

        async function clearAllStaging() {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn TO√ÄN B·ªò danh s√°ch ch·ªù duy·ªát v√†o l·ªãch s·ª≠? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) return;
            try {
                const response = await fetch(`${STAGING_API}/staging/clear`, { method: 'POST' });
                if (response.ok) {
                    alert("ƒê√£ d·ªçn d·∫πp danh s√°ch.");
                    loadData('staging');
                } else {
                    alert("L·ªói khi x·ª≠ l√Ω.");
                }
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi!"); }
        }

        async function deleteStagingItemInModal() {
            const id = document.getElementById('staging_edit_id').value;
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi item n√†y v√† chuy·ªÉn v√†o l·ªãch s·ª≠?")) return;

            try {
                const response = await fetch(`${STAGING_API}/reject/${id}`, { method: 'POST' });
                if (response.ok) {
                    alert("ƒê√£ t·ª´ ch·ªëi v√† l∆∞u l·ªãch s·ª≠.");
                    stagingEditModal.hide();
                    loadData('staging');
                } else {
                    alert("L·ªói khi x·ª≠ l√Ω.");
                }
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi!"); }
        }

        async function openCompare(encodedItem) {
            const stagingItem = JSON.parse(decodeURIComponent(encodedItem));
            currentStagingId = stagingItem.id;

            // Render Right Side (Staging)
            const rightHtml = renderDrugDetails(stagingItem);
            document.getElementById('compare-right').innerHTML = rightHtml;

            // Render Alert
            document.getElementById('alert-conflict-type').innerText =
                stagingItem.conflict_id
                    ? `‚ö†Ô∏è  C·∫£nh b√°o: D·ªØ li·ªáu n√†y xung ƒë·ªôt v·ªõi thu·ªëc hi·ªán c√≥ (ID: ${stagingItem.conflict_id}). Ph√™ duy·ªát s·∫Ω ghi ƒë√® v√† l∆∞u l·ªãch s·ª≠.`
                    : `‚ÑπÔ∏è  Th√¥ng tin: ƒê√¢y l√† thu·ªëc m·ªõi ho√†n to√†n.`;

            // Render Left Side (Current DB)
            const leftContainer = document.getElementById('compare-left');
            leftContainer.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> ƒêang t·∫£i...</div>';

            if (stagingItem.conflict_id) {
                try {
                    const res = await fetch(`${DRUG_API}/${stagingItem.conflict_id}`);
                    if (res.ok) {
                        const currentData = await res.json();
                        leftContainer.innerHTML = renderDrugDetails(currentData);
                    } else {
                        leftContainer.innerHTML = `<div class="text-danger">Kh√¥ng t√¨m th·∫•y thu·ªëc g·ªëc (ID: ${stagingItem.conflict_id})</div>`;
                    }
                } catch (e) {
                    leftContainer.innerHTML = `<div class="text-danger">L·ªói t·∫£i d·ªØ li·ªáu g·ªëc</div>`;
                }
            } else {
                leftContainer.innerHTML = `<em>Kh√¥ng c√≥ d·ªØ li·ªáu c≈© (Thu·ªëc m·ªõi)</em>`;
            }

            compareModal.show();
        }

        function renderDrugDetails(data) {
            return `
                <table class="table table-sm table-borderless mb-0">
                    <tr><td><strong>SƒêK:</strong></td> <td>${data.so_dang_ky || 'N/A'}</td></tr>
                    <tr><td><strong>T√™n:</strong></td> <td class="text-primary fw-bold">${data.ten_thuoc || 'N/A'}</td></tr>
                    <tr><td><strong>Ho·∫°t ch·∫•t:</strong></td> <td>${data.hoat_chat || ''}</td></tr>
                    <tr><td><strong>C√¥ng ty:</strong></td> <td>${data.cong_ty_san_xuat || ''}</td></tr>
                    <tr><td><strong>Ch·ªâ ƒë·ªãnh:</strong></td> <td><small>${data.chi_dinh || ''}</small></td></tr>
                </table>
            `;
        }

        async function confirmApprove() {
            if (!currentStagingId) return;
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën PH√ä DUY·ªÜT thay ƒë·ªïi n√†y?")) return;

            try {
                const res = await fetch(`${STAGING_API}/approve/${currentStagingId}`, { method: 'POST' });
                if (res.ok) {
                    alert("ƒê√£ ph√™ duy·ªát th√†nh c√¥ng!");
                    compareModal.hide();
                    loadData('staging');
                } else {
                    const err = await res.json();
                    alert("L·ªói: " + err.detail);
                }
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi server"); }
        }

        async function confirmReject() {
            if (!currentStagingId) return;
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën T·ª™ CH·ªêI v√† X√ìA y√™u c·∫ßu n√†y?")) return;

            try {
                const res = await fetch(`${STAGING_API}/reject/${currentStagingId}`, { method: 'POST' });
                if (res.ok) {
                    alert("ƒê√£ t·ª´ ch·ªëi th√†nh c√¥ng!");
                    compareModal.hide();
                    loadData('staging');
                } else {
                    const err = await res.json();
                    alert("L·ªói: " + err.detail);
                }
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi server"); }
        }

        function openLinkModal() {
            const modal = new bootstrap.Modal(document.getElementById('linkKnowledgeModal'));
            document.getElementById('linkForm').reset();
            modal.show();
        }

        async function saveLink() {
            const payload = {
                sdk: document.getElementById('link-sdk').value,
                drug_name: document.getElementById('link-drug-name').value || "Unknown Drug",
                icd_code: document.getElementById('link-icd').value,
                disease_name: document.getElementById('link-disease-name').value || "Unknown Disease",
                coverage_type: document.getElementById('link-coverage').value,
                treatment_note: document.getElementById('link-note').value,
                is_verified: document.getElementById('link-verified').checked ? 1 : 0,
                created_by: "admin"
            };

            if (!payload.sdk || !payload.icd_code) {
                alert("Vui l√≤ng nh·∫≠p SDK v√† M√£ ICD");
                return;
            }

            try {
                const resp = await fetch(`${DRUG_API}/knowledge/link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    alert('L∆∞u th√†nh c√¥ng!');
                    // Close modal
                    const modalEl = document.getElementById('linkKnowledgeModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    loadData('links');
                } else {
                    alert('L·ªói: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('L·ªói k·∫øt n·ªëi');
            }
        }
    </script>
</body>

</html>